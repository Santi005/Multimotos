<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Registro</title>
    <link rel="stylesheet" href="css/estilosloginyregistro.css">
    <link rel="shortcut icon" href="img/logoMultimotos.png" type="image/x-icon">
    <link rel="shortcut icon" href="img/logoMultimotos.png" type="image/x-icon">
</head>
<body>
    <button class="home-button" onclick="window.location.href = 'index.html'">
        <i class="fas fa-home"></i>
    </button>
    <div class="container center">
        <h1>Registro</h1>
        <form id="registrationForm">
            <div class="input-field">
                <input type="text" class="form-control" id="InputDocumento" required>
                <label for="InputDocumento">Documento</label>
                <div id="documentoError" class="error-message"></div>
            </div>
            <div class="input-field">
                <input type="text" class="form-control" id="InputNombre" required>
                <label for="InputNombre">Nombre</label>
                <div id="nombreError" class="error-message"></div>
            </div>
            <div class="input-field">
                <input type="text" class="form-control" id="InputApellidos" required>
                <label for="InputApellidos">Apellidos</label>
                <div id="apellidosError" class="error-message"></div>
            </div>
            <div class="input-field">
                <input type="text" class="form-control" id="InputCelular" required>
                <label for="InputCelular">Celular</label>
                <div id="celularError" class="error-message"></div>
            </div>
            <div class="input-field">
                <input type="email" class="form-control" id="InputCorreo" required>
                <label for="InputCorreo">Correo electrónico</label>
                <div id="correoError" class="error-message"></div>
            </div>
            <div class="input-field">
                <input type="text" class="form-control" id="InputDireccion" required>
                <label for="InputDireccion">Dirección</label>
                <div id="direccionError" class="error-message"></div>
            </div>
            <div class="input-field">
                <input type="password" class="form-control" id="InputContrasena" required>
                <label for="InputContrasena">Contraseña</label>
                <div id="contrasenaError" class="error-message"></div>
                <i class="toggle-password fas fa-eye" onclick="togglePasswordVisibility('InputContrasena')"></i>
            </div>

            <div class="input-field confirmar-contra-container">
                <input type="password" class="form-control" id="InputConfirmarContrasena" required>
                <label for="InputConfirmarContrasena">Confirmar Contraseña</label>
                <div id="confirmarContrasenaError" class="error-message"></div>
                <i class="toggle-password fas fa-eye" onclick="togglePasswordVisibility('InputConfirmarContrasena')"></i>
            </div>
            <button type="button" id="BtnRegistrarCliente">Registrarse</button>
            <div class="login_link">
                ¿Ya tienes una cuenta? <a href="loginvista.html">Iniciar sesión</a>
            </div>
        </form>
    </div>
    
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/js/bootstrap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/js/all.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="js/verificartoken.js"></script>
    <script src="js/iconeye.js"></script>

    <script>
        $(document).ready(() => {
            $('#BtnRegistrarCliente').on('click', () => {
                if (validateForm()) {
                    const correo = $('#InputCorreo').val();
                    const documento = $('#InputDocumento').val();
    
                    // Validar si el correo ya está registrado
                    checkEmailExists(correo)
                        .then((emailExists) => {
                            if (emailExists) {
                                $('#correoError').text('El correo ya está registrado.');
                                return;
                            }
    
                            // Validar si el documento ya está registrado
                            checkDocumentoExists(documento)
                                .then((documentoExists) => {
                                    if (documentoExists) {
                                        $('#documentoError').text('El número de documento ya está registrado.');
                                        return;
                                    }
    
                                    // Si todo está validado, realizar el registro
                                    let userData = {
                                        Documento: documento,
                                        Nombre: $('#InputNombre').val(),
                                        Apellidos: $('#InputApellidos').val(),
                                        Celular: $('#InputCelular').val(),
                                        Correo: correo,
                                        Direccion: $('#InputDireccion').val(),
                                        //Id del rol 'Cliente'
                                        Rol: '64defa9c74fb54f6dfe372e9',
                                        Contrasena: $('#InputContrasena').val(),
                                        Estado: 'Activo',
                                    };
    
                                    fetch('http://localhost:8080/users/', {
                                        method: 'POST',
                                        body: JSON.stringify(userData),
                                        headers: {
                                            'Content-type': 'application/json; charset=UTF-8'
                                        }
                                    })
                                    .then(response => response.json())
                                    .then(json => {
                                        alert('Registrado exitosamente');
                                        location.reload();
                                        // Realizar las acciones necesarias después de registrar el usuario
                                    })
                                    .catch(error => {
                                        alert('Ha ocurrido un error al registrar el usuario.');
                                        console.error(error);
                                    });
                                })
                                .catch(error => {
                                    alert('Ha ocurrido un error al verificar el número de documento.');
                                    console.error(error);
                                });
                        })
                        .catch(error => {
                            alert('Ha ocurrido un error al verificar el correo electrónico.');
                            console.error(error);
                        });
                }
            });
    
            function validateForm() {
                let isValid = true;
                // Llamamos a los validadores individuales de cada campo
                isValid = isValid && validateDocumento();
                isValid = isValid && validateNombre();
                isValid = isValid && validateApellidos();
                isValid = isValid && validateCelular();
                isValid = isValid && validateCorreo();
                isValid = isValid && validateDireccion();
                isValid = isValid && validateContrasena();
                isValid = isValid && validateConfirmarContrasena();
                // Agregue aquí más validadores si hay más campos
    
                return isValid;
            }
    
            // Validar Documento
            function validateDocumento() {
                const documento = $('#InputDocumento').val();
                if (!documento.match(/^\d+$/)) {
                    $('#documentoError').text('Documento inválido.');
                    return false;
                } else {
                    $('#documentoError').text('');
                    return true;
                }
            }
    
            // Validar Nombre
            function validateNombre() {
                const nombre = $('#InputNombre').val();
                if (!nombre.match(/^[a-zA-Z\s]+$/)) {
                    $('#nombreError').text('El nombre solo puede contener letras.');
                    return false;
                } else {
                    $('#nombreError').text('');
                    return true;
                }
            }
    
            // Validar Apellidos
            function validateApellidos() {
                const apellidos = $('#InputApellidos').val();
                if (!apellidos.match(/^[a-zA-Z\s]+$/)) {
                    $('#apellidosError').text('Los apellidos solo pueden contener letras.');
                    return false;
                } else {
                    $('#apellidosError').text('');
                    return true;
                }
            }
    
            // Validar Celular
            function validateCelular() {
                const celular = $('#InputCelular').val();
                if (!celular.match(/^\d{10}$/)) {
                    $('#celularError').text('El número de celular debe tener 10 dígitos.');
                    return false;
                } else {
                    $('#celularError').text('');
                    return true;
                }
            }
    
            // Validar Correo
            function validateCorreo() {
                const correo = $('#InputCorreo').val();
                if (!correo.match(/^\w+([\.-]?\w+)*@\w+([\.-]?\w+)*(\.\w{2,3})+$/)) {
                    $('#correoError').text('Ingrese un correo electrónico válido.');
                    return false;
                } else {
                    $('#correoError').text('');
                    return true;
                }
            }
    
            // Validar Dirección
            function validateDireccion() {
                const direccion = $('#InputDireccion').val();
                if (direccion.trim().length === 0) {
                    $('#direccionError').text('La dirección no puede estar vacía.');
                    return false;
                } else if (direccion.length > 40) {
                    $('#direccionError').text('La dirección no puede tener más de 40 caracteres.');
                    return false;
                } else {
                    $('#direccionError').text('');
                    return true;
                }
            }
    
            // Validar Contraseña
            function validateContrasena() {
                const contrasena = $('#InputContrasena').val();
                if (contrasena.trim().length === 0) {
                    $('#contrasenaError').text('La contraseña no puede estar vacía.');
                    return false;
                } else {
                    $('#contrasenaError').text('');
                    return true;
                }
            }
    
            // Validar Confirmar Contraseña
            function validateConfirmarContrasena() {
                const contrasena = $('#InputContrasena').val();
                const confirmarContrasena = $('#InputConfirmarContrasena').val();
                if (contrasena !== confirmarContrasena) {
                    $('#confirmarContrasenaError').text('Las contraseñas no coinciden.');
                    return false;
                } else {
                    $('#confirmarContrasenaError').text('');
                    return true;
                }
            }
    
            // Función para verificar si el correo ya está registrado
            function checkEmailExists(correo) {
                return new Promise((resolve, reject) => {
                    fetch(`http://localhost:8080/users/check-email/${correo}`)
                        .then(response => response.json())
                        .then(json => {
                            resolve(json.exists);
                        })
                        .catch(error => {
                            reject(error);
                        });
                });
            }
    
            // Función para verificar si el documento ya está registrado
            function checkDocumentoExists(documento) {
                return new Promise((resolve, reject) => {
                    fetch(`http://localhost:8080/users/check-documento/${documento}`)
                        .then(response => response.json())
                        .then(json => {
                            resolve(json.exists);
                        })
                        .catch(error => {
                            reject(error);
                        });
                });
            }
        });
    </script>
    
    
    
</body>
</html>
